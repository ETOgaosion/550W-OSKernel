# 文件系统功能

本小节从不同方面介绍了当前文件系统支持的一些功能以及一些基本实现思路。

## 1.基本磁盘解析函数

包括加载目录/文件，修改目录/文件，文件名解析，遍历目录，切换路径等功能。

文件与目录的加载/写回可以通过目录项中的file size确定大小或者通过first cluster确定其目前占用哪些cluster。

目录的修改主要包括创建子目录/文件等功能。

目录遍历需要通过依次确定目录项的分组、对比名称以及相关信息确定文件在目录中的位置。

路径切换则是根据目标dir数据更新当前dir的信息。

## 2.文件描述符

当前文件描述符在所有进程间共用，支持STDIN/STDOUT/STDERR，pipe等必要功能。目前文件描述符的主体是一个大数组，所有进程在这个数组中申请/释放文件描述符，后续需要完成文件描述符在进程之间的隔离。

对于STDIN/OUT/ERR类的文件描述符，需要维护输入/输出的缓冲区。

对于pipe，需要维护一个一个ring buffer，实现pipe两端的成功读写。

对于file/dir，需要维护文件的基本信息，文件描述符的访问模式、当前访问位置等数据。

## 3.系统调用

基于前两部分功能的支持，我们实现了文件系统相关的系统调用，包括：

- **SYS_getcwd 17**

  获取当前工作目录，打印进程维护的当前工作目录

- **SYS_dup 23**

  复制文件描述符，文件引用加1

- **SYS_dup3 24**

  复制到指定的文件描述符，文件引用加1

- **SYS_chdir 49**

  搜索目标目录，切换当前工作目录

- **SYS_openat 56**

  打开或创建文件，并且获取该文件的文件描述符

- **SYS_close 57**

  释放一个文件描述符，文件引用减1

- **SYS_getdents64 61**

  获取文件描述符指向的目录的下一个文件/子目录信息

- **SYS_read 63**

  从文件描述符读区指定长度到buf，返回实际读区的字节数，注意文件末尾

- **SYS_write 64**

  向文件描述符写入buf中的指定长度，返回实际写入内容，注意文件末尾

- **SYS_linkat 37**

  fat32标准不存储文件链接数，可实现在抽象的上层文件系统

- **SYS_unlinkat 35**

  删除指定的文件链接，文件链接数为1时删除

- **SYS_mkdirat 34**

  创建指定的目录

- **SYS_umount2 39**

  取消指定设备的挂载

- **SYS_mount 40**

  将磁盘中的文件系统设备挂载到指定目录下，该目录作为磁盘中文件系统的根目录

- **SYS_fstat 80**

  打印文件描述符指向文件的信息

## 4.TODO

完善文件系统的虚拟化，提高文件系统的抽象层次，简化文件描述符、系统调用等与磁盘文件的交互。