### 文件系统解析

本节主要结合fat32文件系统格式，说明本小组如何实现对fat32磁盘的解析。

##### 1.文件系统初始化

对于未分区的fat32磁盘文件来说，0号扇区往往存储了解析磁盘格式所需的全部信息，主要包括：

| Offset(hex) | Size(bytes) | describe                |
| ----------- | ----------- | ----------------------- |
| 0x0B        | 2           | Bytes per sector        |
| 0x0D        | 1           | Sectors per cluster     |
| 0x0E        | 2           | Reserved sectors        |
| 0x10        | 1           | Number of fats          |
| 0x13        | 2           | Sector num(lo)          |
| 0x20        | 4           | Sector num(hi)          |
| 0x1c        | 4           | Hidden sec              |
| 0x024       | 4           | Sectors per fat         |
| 0x02c       | 4           | Cluster num of root dir |
| 0x052       | 8           | Identifier "Fat32     " |

根据这些信息，我们可以进一步计算得到与fat32磁盘交互所需的所有数据，进而完成文件系统的初始化。

##### 2.File Allocation Table

Fat32以一个数组形式的File Allocation Table表示磁盘的使用状态。每个文件可以通过保存first cluster来向后寻找到文件占有的所有cluster。

```c
next_cluster = fat[cur_cluster] & FAT_MASK;
```

##### 3.目录格式

目录项的大小固定为32B，主要包括文件的权限，大小，名称等信息。为了保存较长的文件名，往往由连续的一个或多个目录项构成一组，共同表示一个文件。每组目录项的最后一个为短目录项，其余为长目录项。

按照fat32规范，如果文件需要长目录项，整个文件名都存储在长目录项中；否则以8.3格式放在短目录中。为避免麻烦，这里可以统一使用长目录项存储文件名。（只要保证自洽）

##### 4.磁盘驱动

实现virtio驱动，重点是对磁盘扇区的读写。



[1.]: https://wiki.osdev.org/FAT#BPB_.28BIOS_Parameter_Block.29
[2]: https://www.cnblogs.com/Chary/p/12981056.html

### 文件系统功能

本小节从不同方面介绍了当前文件系统支持的一些功能以及一些基本实现思路。

##### 1.基本磁盘解析函数

包括加载目录/文件，修改目录/文件，文件名解析，遍历目录，切换路径等功能。

文件与目录的加载/写回可以通过目录项中的file size确定大小或者通过first cluster确定其目前占用哪些cluster。

目录的修改主要包括创建子目录/文件等功能。

目录遍历需要通过依次确定目录项的分组、对比名称以及相关信息确定文件在目录中的位置。

路径切换则是根据目标dir数据更新当前dir的信息。

##### 2.文件描述符

当前文件描述符在所有进程间共用，支持STDIN/STDOUT/STDERR，pipe等必要功能。目前文件描述符的主体是一个大数组，所有进程在这个数组中申请/释放文件描述符，后续需要完成文件描述符在进程之间的隔离。

对于STDIN/OUT/ERR类的文件描述符，需要维护输入/输出的缓冲区。

对于pipe，需要维护一个一个ring buffer，实现pipe两端的成功读写。

对于file/dir，需要维护文件的基本信息，文件描述符的访问模式、当前访问位置等数据。

##### 3.系统调用

基于前两部分功能的支持，我们实现了文件系统相关的系统调用，包括：

- **SYS_getcwd 17**

  获取当前工作目录，打印进程维护的当前工作目录

- **SYS_dup 23**

  复制文件描述符，文件引用加1

- **SYS_dup3 24**

  复制到指定的文件描述符，文件引用加1

- **SYS_chdir 49**

  搜索目标目录，切换当前工作目录

- **SYS_openat 56**

  打开或创建文件，并且获取该文件的文件描述符

- **SYS_close 57**

  释放一个文件描述符，文件引用减1

- **SYS_getdents64 61**

  获取文件描述符指向的目录的下一个文件/子目录信息

- **SYS_read 63**

  从文件描述符读区指定长度到buf，返回实际读区的字节数，注意文件末尾

- **SYS_write 64**

  向文件描述符写入buf中的指定长度，返回实际写入内容，注意文件末尾

- **SYS_linkat 37**

  fat32标准不存储文件链接数，可实现在抽象的上层文件系统

- **SYS_unlinkat 35**

  删除指定的文件链接，文件链接数为1时删除

- **SYS_mkdirat 34**

  创建指定的目录

- **SYS_umount2 39**

  取消指定设备的挂载

- **SYS_mount 40**

  将磁盘中的文件系统设备挂载到指定目录下，该目录作为磁盘中文件系统的根目录

- **SYS_fstat 80**

  打印文件描述符指向文件的信息

##### 4.TODO

完善文件系统的虚拟化，提高文件系统的抽象层次，简化文件描述符、系统调用等与磁盘文件的交互。