# I/O

因为OpenSBI本身不支持磁盘读写，因此需要为qemu virtio功能编写驱动程序。本身我们的设计是内核不支持中断，但virtio驱动采用外部中断的方式触发内核响应，因此需要在内核中加入嵌套中断和外部中断的支持。具体来说，需要在进入内核S态的时候将中断向量`stvec`置为内核中断处理入口，在中断发生时将所有寄存器存入当前栈底向下的空间中，不能覆盖其他已用区域；在处理完中断后重新加载所有寄存器，继续执行。

经过测试，所有核均能收到外部中断，因此在处理内核中断的时候还需要使用锁，本组采用自旋锁实现。

支持外部中断后，对vitio块设备驱动进行实现，利用virtio ring descriptor进行扇区的读写，利用plic对外部中断进行设置和处理。全部流程严格按照[手册](https://docs.oasis-open.org/virtio/virtio/v1.1/csprd01/virtio-v1.1-csprd01.html)设计、执行。